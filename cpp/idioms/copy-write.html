<div data-github-url="https://github.com/kamranahmedse/developer-roadmap/tree/master/src/data/roadmaps/cpp/content/112-idioms/106-copy-write.md"></div> <h1 id="copy-write-idiom">Copy-Write Idiom</h1>
<p>The Copy-Write idiom, sometimes called the Copy-on-Write (CoW) or “lazy copying” idiom, is a technique used in programming to minimize the overhead of copying large objects. It helps in reducing the number of actual copy operations by using shared references to objects and only copying the data when it’s required for modification.</p>
<p>Let’s understand this with a simple example:</p>
<pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#FF79C6">#include</span><span style="color:#E9F284"> &#x3C;</span><span style="color:#F1FA8C">iostream</span><span style="color:#E9F284">></span></span>
<span class="line"><span style="color:#FF79C6">#include</span><span style="color:#E9F284"> &#x3C;</span><span style="color:#F1FA8C">memory</span><span style="color:#E9F284">></span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">class</span><span style="color:#8BE9FD"> MyString</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#FF79C6">public:</span></span>
<span class="line"><span style="color:#50FA7B">    MyString</span><span style="color:#F8F8F2">(</span><span style="color:#FF79C6">const</span><span style="color:#F8F8F2"> std</span><span style="color:#FF79C6">::</span><span style="color:#8BE9FD;font-style:italic">string</span><span style="color:#FF79C6"> &#x26;</span><span style="color:#FFB86C;font-style:italic">str</span><span style="color:#F8F8F2">) : </span><span style="color:#50FA7B">data</span><span style="color:#F8F8F2">(std</span><span style="color:#FF79C6">::</span><span style="color:#50FA7B">make_shared</span><span style="color:#F8F8F2">&#x3C;std</span><span style="color:#FF79C6">::</span><span style="color:#8BE9FD;font-style:italic">string</span><span style="color:#F8F8F2">>(str)) {}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4">    // Use the same shared data for copying.</span></span>
<span class="line"><span style="color:#50FA7B">    MyString</span><span style="color:#F8F8F2">(</span><span style="color:#FF79C6">const</span><span style="color:#8BE9FD;font-style:italic"> MyString</span><span style="color:#FF79C6"> &#x26;</span><span style="color:#FFB86C;font-style:italic">other</span><span style="color:#F8F8F2">) : </span><span style="color:#50FA7B">data</span><span style="color:#F8F8F2">(other.data) { </span></span>
<span class="line"><span style="color:#F8F8F2">        std</span><span style="color:#FF79C6">::</span><span style="color:#F8F8F2">cout </span><span style="color:#FF79C6">&#x3C;&#x3C;</span><span style="color:#E9F284"> "</span><span style="color:#F1FA8C">Copied using the Copy-Write idiom.</span><span style="color:#E9F284">"</span><span style="color:#FF79C6"> &#x3C;&#x3C;</span><span style="color:#F8F8F2"> std</span><span style="color:#FF79C6">::</span><span style="color:#F8F8F2">endl;</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4">    // Make a copy only if we want to modify the data.</span></span>
<span class="line"><span style="color:#FF79C6">    void</span><span style="color:#50FA7B"> write</span><span style="color:#F8F8F2">(</span><span style="color:#FF79C6">const</span><span style="color:#F8F8F2"> std</span><span style="color:#FF79C6">::</span><span style="color:#8BE9FD;font-style:italic">string</span><span style="color:#FF79C6"> &#x26;</span><span style="color:#FFB86C;font-style:italic">str</span><span style="color:#F8F8F2">) {</span></span>
<span class="line"><span style="color:#6272A4">        // Check if there's more than one reference.</span></span>
<span class="line"><span style="color:#FF79C6">        if</span><span style="color:#F8F8F2">(</span><span style="color:#FF79C6">!</span><span style="color:#F8F8F2">data.</span><span style="color:#50FA7B">unique</span><span style="color:#F8F8F2">()) {</span></span>
<span class="line"><span style="color:#F8F8F2">            data </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> std</span><span style="color:#FF79C6">::</span><span style="color:#50FA7B">make_shared</span><span style="color:#F8F8F2">&#x3C;std</span><span style="color:#FF79C6">::</span><span style="color:#8BE9FD;font-style:italic">string</span><span style="color:#F8F8F2">>(</span><span style="color:#FF79C6">*</span><span style="color:#F8F8F2">data);</span></span>
<span class="line"><span style="color:#F8F8F2">            std</span><span style="color:#FF79C6">::</span><span style="color:#F8F8F2">cout </span><span style="color:#FF79C6">&#x3C;&#x3C;</span><span style="color:#E9F284"> "</span><span style="color:#F1FA8C">Copy is actually made for writing.</span><span style="color:#E9F284">"</span><span style="color:#FF79C6"> &#x3C;&#x3C;</span><span style="color:#F8F8F2"> std</span><span style="color:#FF79C6">::</span><span style="color:#F8F8F2">endl;</span></span>
<span class="line"><span style="color:#F8F8F2">        }</span></span>
<span class="line"><span style="color:#FF79C6">        *</span><span style="color:#F8F8F2">data </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> str;</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">private:</span></span>
<span class="line"><span style="color:#F8F8F2">    std</span><span style="color:#FF79C6">::</span><span style="color:#F8F8F2">shared_ptr</span><span style="color:#FF79C6">&#x3C;</span><span style="color:#F8F8F2">std</span><span style="color:#FF79C6">::</span><span style="color:#F8F8F2">string</span><span style="color:#FF79C6">></span><span style="color:#F8F8F2"> data;</span></span>
<span class="line"><span style="color:#F8F8F2">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">int</span><span style="color:#50FA7B"> main</span><span style="color:#F8F8F2">() {</span></span>
<span class="line"><span style="color:#F8F8F2">    MyString </span><span style="color:#50FA7B">str1</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">"</span><span style="color:#F1FA8C">Hello</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">);</span></span>
<span class="line"><span style="color:#F8F8F2">    MyString str2 </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> str1;</span><span style="color:#6272A4"> // No copy operation, just shared references.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2">    str1.</span><span style="color:#50FA7B">write</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">"</span><span style="color:#F1FA8C">Hello, World!</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">);</span><span style="color:#6272A4"> // This is where the actual duplication happens.</span></span>
<span class="line"><span style="color:#FF79C6">    return</span><span style="color:#BD93F9"> 0</span><span style="color:#F8F8F2">;</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre>
<p>In this example, we have a class <code>MyString</code> that simulates the Copy-Write idiom. When a <code>MyString</code> object is created, it constructs a <code>shared_ptr</code> pointing to a string. When a <code>MyString</code> object is copied, it does not perform any actual copy operation, but simply increases the reference count of the shared object. Finally, when the <code>write</code> function is called, it checks if there’s more than one reference to the data and if so, it actually creates a new copy and updates the reference. This way, unnecessary copies can be avoided until they are actually needed for modification.</p>